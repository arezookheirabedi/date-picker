stages:
  - build
  - dockerize
  - rollout


#######################STAGE_MINISTER_START#######################

node-build-Develop:
  stage: build
  tags:
    - master1
  cache: 
   key: ${CI_JOB_I}
   paths:
    - node_modules/
    - public/
  image: registry.vaslapp.com/docker/node:14.17.2-alpine3.13
  script:
    - echo 'nameserver 8.8.8.8' > /etc/resolv.conf
    - npm version
    - CI=false yarn install
    - CI=false yarn run build:development
  artifacts:
    expire_in: 4h
    paths:
      - build/
  only:
    - develop


dockerize-Develop:
  stage: dockerize
  tags: 
    - master1
  dependencies:
    - node-build-Develop
  image: buildah/buildah
  script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.vaslapp.com
    - buildah build-using-dockerfile -t registry.vaslapp.com/docker/ministers-dev:latest .
    - buildah push registry.vaslapp.com/docker/ministers-dev:latest
  only:
    - develop

    
rollout-Develop:
  stage: rollout
  tags:
    - kuber
  image:
    name: bitnami/kubectl
    entrypoint: [ "" ]
  script:
    - echo "$KUBERGOV_CONFIG" | base64 -d >.config
    - kubectl rollout restart deployment ministers --kubeconfig .config --namespace connect
  only:
    - develop

#######################STAGE_MINISTER_END#######################

#######################PROD_MINISTER_START#######################

node-build-Prod:
  stage: build
  tags: 
    - master1
  cache:
   key: ${CI_JOB_I}
   paths:
    - node_modules/
    - public/
  image: node:14.17.2-alpine3.13
  script:
    - echo 'nameserver 8.8.8.8' > /etc/resolv.conf
    - npm version
    - CI=false yarn install
    - CI=false yarn run build:production
  artifacts:
    expire_in: 4h
    paths:
      - build/
  only:
    - master

dockerize-Prod:
  stage: dockerize
  tags: 
    - master1
  dependencies:
    - node-build-Prod
  image: buildah/buildah
  script:
    - buildah login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.vaslapp.com
    - buildah build-using-dockerfile -t registry.vaslapp.com/docker/ministers:latest .
    - buildah push registry.vaslapp.com/docker/ministers:latest
  only:
    - master


rollout-Prod:
  stage: rollout
  tags:
    - omid-prod
  image:
    name: bitnami/kubectl
    entrypoint: [ "" ]
  script:
    - echo "$KUBERBOH_CONFIG" | base64 -d >.config
    - kubectl rollout restart deployment ministers --kubeconfig .config --namespace connect
  only:
    - master
  when: manual
  
#######################PROD_MINISTER_END#######################